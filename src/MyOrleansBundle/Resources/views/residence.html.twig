{% extends 'MyOrleansBundle::layout.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('css/residence.css') }}" rel="stylesheet" type="text/css"/>
{% endblock %}

{% block content %}
    <div id="residence">
        <div class="row">
            <div class="col offset-s1 retourSearch1">
                <a class="waves-effect waves-light btn"
                   href="{{ path("nosresidences") }}">
                    <i class="fa fa-caret-left white-text"></i> RETOUR AUX RÉSIDENCES</a>
            </div>
        </div>

        <!-- Slider Residence -->
        <div class="sliderResidence">
            <div class="slider">
                <ul class="slides">
                    <li>
                        {% for media in residence.medias if media.typeMedia.nom == 'image-cover' %}
                            <img id="image" src="{{ asset('uploads/'~media.mediaName) }}" alt="résidence">
                        {% endfor %}
                        {% if residence.lienYoutube != null %}
                            <a href="#modalYtp"><i class="material-icons white-text">play_circle_outline</i></a>
                        {% endif %}
                        <div class="encart center">
                            <h2>{{ residence.nom }}</h2>
                            <p>{{ residence.ville.nom }}{% if residence.quartier != null %} - {{ residence.quartier.nom }}{% endif %}
                            </p>
                        </div>

                    </li>
                    {% for media in residence.medias if media.typeMedia.nom == 'image' %}
                        <li>
                            <img src="{{ asset('uploads/'~media.mediaName) }}" alt="résidence">
                        </li>
                    {% endfor %}
                </ul>
                <div class="col s12">
                    <button class="prev btn-flat"><i class="material-icons white-text">chevron_left</i></button>
                    <button class="next btn-flat"><i class="material-icons white-text">chevron_right</i></button>
                </div>
            </div>
        </div>

        <!-- Modal Video Youtube -->
        <div id="modalYtp" class="modal">
            <div class="modal-content">
                <div class="video-container">
                    <iframe src="http://www.youtube.com/embed/{{ residence.lienYoutube }}?autoplay=0&modestbranding=1&rel=0&showinfo=0"
                            frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col offset-xl1 s12 l5 xl4 cartouche">
                <span class="col s12 center">À partir de {{ prixMin|number_format(0, '.', ' ') }}€</span>
                <div class="cartoucheInfo">
                    <p class="col s12">Livraison {{ residence.dateLivraison }}</p>
                    <p class="col s12">Du {{ typeMin }} au {{ typeMax }}</p>
                    {% transchoice flatsDispo %}
                    {1} <p class="col s12">%count% lot disponible</p> |
                    ]1,Inf[ <p class="col s12">%count% lots disponibles</p>
                    {% endtranschoice %}
                </div>
            </div>

            <!-- Compteurs Notes -->
            <div class="col offset-xl1 s12 l7 xl5 box-notesite">
                <div class="row">
                    <ul>
                        <li class="design col s6 m3">
                            <div class="notesite" id="note_0"
                                 data-note="{{ residence.noteTransports|number_format(2,'.') }}"></div>
                            <br/>
                            <div class="list-legend">
                                <div class="row center-align">
                                    <ul>
                                        <li class="design col m12">transports</li>
                                    </ul>
                                </div>
                            </div>
                        </li>
                        <li class="content col s6 m3">
                            <div class="notesite" id="note_3"
                                 data-note="{{ residence.noteCommerces|number_format(2,'.') }}"></div>
                            <br/>
                            <div class="list-legend">
                                <div class="row">
                                    <ul>
                                        <li class="design col m12">commerces</li>
                                    </ul>
                                </div>
                            </div>
                        </li>
                        <li class="creativity col s6 m3">
                            <div class="notesite" id="note_1"
                                 data-note="{{ residence.noteServices|number_format(2,'.') }}"></div>
                            <div class="list-legend">
                                <div class="row">
                                    <ul>
                                        <li class="design col m12">services</li>
                                    </ul>
                                </div>
                            </div>
                        </li>
                        <li class="usability col s6 m3">
                            <div class="notesite" id="note_2"
                                 data-note="{{ residence.noteEsthetisme|number_format(2,'.') }}"></div>
                            <div class="list-legend">
                                <div class="row">
                                    <ul>
                                        <li class="design col m12">esthétisme</li>
                                    </ul>
                                </div>
                            </div>
                        </li>
                        <!-- pour les notes, on les rentre de BAS EN HAUT. celle du bas est donc transport, celle du haut esthétisme  -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 2nde Navbar -->
    <div class="row">
        <div class="col offset-l2 s12 l8" id="menuResidence">
            <nav>
                <div class="nav-wrapper center">
                    <ul>
                        <li class="col s4" id="residenceNav"><a href="#anchor-residence">La résidence</a></li>
                        <li class="col s4" id="localisationNav"><a href="#anchor-localisation">Localisation</a></li>
                        <li class="col s4" id="bienNav"><a href="#anchor-bien">Nos biens</a></li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>

    <!-- Effet Parallax -->
    <div id="anchor-residence" class="parallax-container">
        {#<div class="parallax">#}
        {#<img src="{{ asset('img/parallax1.jpg') | imagine_filter('thumb_photo_residence') }}" alt="famille">#}
        {#</div>#}
    </div>

    <!-- Description Résidence -->
    <div class="row">
        <div class="col offset-l2 s12 l6">
            <div class="card-panel accrocheResidence">
                <h3 class="center accroche">{{ residence.accroche }}</h3>
                <div class="description">{{ residence.description | raw }}</div>
            </div>
        </div>
        {% if residence.offre != null %}
        <div class="col offset-l1 l2" id="offre">
            <div class="flip-container" ontouchstart="this.classList.toggle('hover');">
                <div class="flipper">
                    <div class="front">
                        <img class="vignette" src="{{ asset('img/offreFile.png') }}">
                        {% for media in residence.medias if media.typeMedia.nom == 'icone' %}
                        <img class="iconeOffre" src="{{ asset('uploads/'~media.mediaName) }}" alt="offre">
                        {% endfor %}
                    </div>
                    <div class="back">
                        <p>{{ residence.offre }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Effet Parallax -->
    <div id="anchor-localisation" class="parallax-container">
        {#<div class="parallax">#}
        {#<img src="{{ asset('img/parallax2.jpg') | imagine_filter('thumb_photo_residence') }}" alt="famille">#}
        {#</div>#}
    </div>

    <!-- Situation Résidence GoogleMap -->

    <h1>Situation de la résidence</h1>

    <div class="row">

        <!-- Carte GoogleMap -->
        <div class="col offset-l2 s12 l6">
            <div class="card" id="map"></div>
        </div>

        <!-- Filtre Places GoogleMap -->
        <div class="col l2 center filtreMap">
            <div class="commerce">
                <div class="row">
                    <p class="col offset-s2 s8">Commerces</p>
                </div>
                <div class="row" id="commerce"></div>
            </div>
            <div class="service">
                <div class="row">
                    <p class="col offset-s3 s6">Services</p>
                </div>
                <div class="row" id="service"></div>
            </div>
            <div class="transport">
                <div class="row">
                    <p class="col offset-s2 s8">Transports</p>
                </div>
                <div class="row" id="transport"></div>
            </div>
        </div>
    </div>

    <!-- Effet Parallax -->
    <div id="anchor-bien" class="parallax-container">
        {#<div class="parallax">#}
        {#<img src="{{ asset('img/parallax3.jpg') | imagine_filter('thumb_photo_residence') }}" alt="famille">#}
        {#</div>#}
    </div>

    <!-- Tableau lots disponibles -->
    <h1>Consultez nos biens disponibles</h1>

    <div class="row">
        <div class="col offset-l2 s12 l8">
            <div class="accordeon-residence center">
                <div class="row accordeon-entete">
                    <div class="col s2 l3 colType">Type</div>
                    <div class="col s4 l3 colSurface">Surface habitable</div>
                    <div class="col s4 l3 colPrix">Prix</div>
                    <div class="col s2 l3 colDispo">Disponibilité</div>
                </div>
                <ul class="collapsible" data-collapsible="accordion">
                    {% if flatsT1 != null %}
                        <li>
                            <div class="collapsible-header">
                                <div class="row">
                                    <div class="col s2 l3">1 pièce</div>
                                    <div class="col s4 l3">
                                        {% for flat in flatsT1 %}
                                            {% if loop.first %}{{ flat.surface }}{% endif %}
                                        {% endfor %}
                                        m<sup>2</sup> à
                                        {% for flat in flatsT1 %}
                                            {% if loop.last %}{{ flat.surface }}{% endif %}
                                        {% endfor %}
                                        m<sup>2</sup>
                                    </div>
                                    <div class="col s4 l3">
                                        à partir de
                                        {% for flat in flatsT1 %}
                                            {% if loop.first %}{{ flat.prix|number_format(0, '.', ' ') }}{% endif %}
                                        {% endfor %}
                                        €
                                    </div>
                                    <div class="col s2 l3 ">
                                        <div class="btn greenMyO">
                                            {% transchoice T1Dispo %}
                                            {1} %count% logement |
                                            ]1,Inf[ %count% logements
                                            {% endtranschoice %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="collapsible-body">
                                {% for flat in flatsT1 %}
                                    <div class="row">
                                        {% if flat.statut %}
                                            <a href="{{ path('appartement', { 'id': flat.id }) }}">
                                                <div class="col s2 l3 info">{{ flat.typeLogement.nom }}</div>
                                                <div class="col s4 l3">{{ flat.surface }} m<sup>2</sup></div>
                                                <div class="col s4 l3">{{ flat.prix|number_format(0, '.', ' ') }}€
                                                </div>
                                                <div class="col s2 l3">
                                                    <div class="btn white black-text">Voir</div>
                                                </div>
                                            </a>
                                        {% else %}

                                            <div class="col s2 l3"><i>{{ flat.typeLogement.nom }}</i></div>
                                            <div class="col s4 l3"><i>{{ flat.surface }} m<sup>2</sup></i></div>
                                            <div class="col s4 l3"><i>{{ flat.prix|number_format(0, '.', ' ') }} €</i>
                                            </div>
                                            <div class="col s2 l3"><i>Vendu</i>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </li>
                    {% endif %}
                    {% if flatsT2 != null %}
                        <li>
                            <div class="collapsible-header">
                                <div class="row">
                                    <div class="col s2 l3">2 pièces</div>
                                    <div class="col s4 l3">
                                        {% for flat in flatsT2 %}
                                            {% if loop.first %}{{ flat.surface }}{% endif %}
                                        {% endfor %}
                                        m<sup>2</sup> à
                                        {% for flat in flatsT2 %}
                                            {% if loop.last %}{{ flat.surface }}{% endif %}
                                        {% endfor %}
                                        m<sup>2</sup>
                                    </div>
                                    <div class="col s4 l3">
                                        à partir de
                                        {% for flat in flatsT2 %}
                                            {% if loop.first %}{{ flat.prix|number_format(0, '.', ' ') }}{% endif %}
                                        {% endfor %}
                                        €
                                    </div>
                                    <div class="col s2 l3 ">
                                        <div class="btn greenMyO">
                                            {% transchoice T2Dispo %}
                                            {1} %count% logement|
                                            ]1,Inf[ %count% logements
                                            {% endtranschoice %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="collapsible-body">
                                {% for flat in flatsT2 %}
                                    <div class="row">
                                        {% if flat.statut %}
                                            <a href="{{ path('appartement', { 'id': flat.id }) }}">
                                                <div class="col s2 l3">{{ flat.typeLogement.nom }}</div>
                                                <div class="col s4 l3">{{ flat.surface }} m<sup>2</sup></div>
                                                <div class="col s4 l3">{{ flat.prix|number_format(0, '.', ' ') }}€
                                                </div>
                                                <div class="col s2 l3">
                                                    <div class="col s2 l3">
                                                        <div class="btn white black-text">Voir</div>
                                                    </div>
                                                </div>
                                            </a>
                                        {% else %}

                                            <div class="col s2 l3"><i>{{ flat.typeLogement.nom }}</i></div>
                                            <div class="col s4 l3"><i>{{ flat.surface }} m<sup>2</sup></i></div>
                                            <div class="col s4 l3"><i>{{ flat.prix|number_format(0, '.', ' ') }} €</i>
                                            </div>
                                            <div class="col s2 l3"><i>Vendu</i>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </li>
                    {% endif %}
                    {% if flatsT3 != null %}
                        <li>
                            <div class="collapsible-header">
                                <div class="row">
                                    <div class="col s2 l3">3 pièces</div>
                                    <div class="col s4 l3">
                                        {% for flat in flatsT3 %}
                                            {% if loop.first %}{{ flat.surface }}{% endif %}
                                        {% endfor %}
                                        m<sup>2</sup> à
                                        {% for flat in flatsT3 %}
                                            {% if loop.last %}{{ flat.surface }}{% endif %}
                                        {% endfor %}
                                        m<sup>2</sup>
                                    </div>
                                    <div class="col s4 l3">
                                        à partir de
                                        {% for flat in flatsT3 %}
                                            {% if loop.first %}{{ flat.prix|number_format(0, '.', ' ') }}{% endif %}
                                        {% endfor %}
                                        €
                                    </div>
                                    <div class="col s2 l3 ">
                                        <div class="btn greenMyO">
                                            {% transchoice T3Dispo %}
                                            {1} %count% logement|
                                            ]1,Inf[ %count% logements
                                            {% endtranschoice %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="collapsible-body">
                                {% for flat in flatsT3 %}
                                    <div class="row">
                                        {% if flat.statut %}
                                            <a href="{{ path('appartement', { 'id': flat.id }) }}">
                                                <div class="col s2 l3">{{ flat.typeLogement.nom }}</div>
                                                <div class="col s4 l3">{{ flat.surface }} m<sup>2</sup></div>
                                                <div class="col s4 l3">{{ flat.prix|number_format(0, '.', ' ') }}€
                                                </div>
                                                <div class="col s2 l3">
                                                    <div class="btn white black-text">Voir</div>
                                                </div>
                                            </a>
                                        {% else %}

                                            <div class="col s2 l3"><i>{{ flat.typeLogement.nom }}</i></div>
                                            <div class="col s4 l3"><i>{{ flat.surface }} m<sup>2</sup></i></div>
                                            <div class="col s4 l3"><i>{{ flat.prix|number_format(0, '.', ' ') }} €</i>
                                            </div>
                                            <div class="col s2 l3"><i>Vendu</i>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </li>
                    {% endif %}
                    {% if flatsT4 != null %}
                        <li>
                            <div class="collapsible-header">
                                <div class="row">
                                    <div class="col s2 l3">4 pièces</div>
                                    <div class="col s4 l3">
                                        {% for flat in flatsT4 %}
                                            {% if loop.first %}{{ flat.surface }}{% endif %}
                                        {% endfor %}
                                        m<sup>2</sup> à
                                        {% for flat in flatsT4 %}
                                            {% if loop.last %}{{ flat.surface }}{% endif %}
                                        {% endfor %}
                                        m<sup>2</sup>
                                    </div>
                                    <div class="col s4 l3">
                                        à partir de
                                        {% for flat in flatsT4 %}
                                            {% if loop.first %}{{ flat.prix|number_format(0, '.', ' ') }}{% endif %}
                                        {% endfor %}
                                        €
                                    </div>
                                    <div class="col s2 l3 ">
                                        <div class="btn greenMyO">
                                            {% transchoice T4Dispo %}
                                            {1} %count% logement|
                                            ]1,Inf[ %count% logements
                                            {% endtranschoice %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="collapsible-body">
                                {% for flat in flatsT4 %}
                                    <div class="row">
                                        {% if flat.statut %}
                                            <a href="{{ path('appartement', { 'id': flat.id }) }}">
                                                <div class="col s2 l3">{{ flat.typeLogement.nom }}</div>
                                                <div class="col s4 l3">{{ flat.surface }} m<sup>2</sup></div>
                                                <div class="col s4 l3">{{ flat.prix|number_format(0, '.', ' ') }}€
                                                </div>
                                                <div class="col s2 l3">
                                                    <div class="btn white black-text">Voir</div>
                                                </div>
                                            </a>
                                        {% else %}

                                            <div class="col s2 l3"><i>{{ flat.typeLogement.nom }}</i></div>
                                            <div class="col s4 l3"><i>{{ flat.surface }} m<sup>2</sup></i></div>
                                            <div class="col s4 l3"><i>{{ flat.prix|number_format(0, '.', ' ') }} €</i>
                                            </div>
                                            <div class="col s2 l3"><i>Vendu</i>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </li>
                    {% endif %}
                    {% if flatsT5 != null %}
                        <li>
                            <div class="collapsible-header">
                                <div class="row">
                                    <div class="col s2 l3">5 pièces et plus</div>
                                    <div class="col s4 l3">
                                        {% for flat in flatsT5 %}
                                            {% if loop.first %}{{ flat.surface }}{% endif %}
                                        {% endfor %}
                                        m<sup>2</sup> à
                                        {% for flat in flatsT5 %}
                                            {% if loop.last %}{{ flat.surface }}{% endif %}
                                        {% endfor %}
                                        m<sup>2</sup>
                                    </div>
                                    <div class="col s4 l3">
                                        à partir de
                                        {% for flat in flatsT5 %}
                                            {% if loop.first %}{{ flat.prix|number_format(0, '.', ' ') }}{% endif %}
                                        {% endfor %}
                                        €
                                    </div>
                                    <div class="col s2 l3 ">
                                        <div class="btn greenMyO">
                                            {% transchoice T5Dispo %}
                                            {1} %count% logement|
                                            ]1,Inf[ %count% logements
                                            {% endtranschoice %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="collapsible-body">
                                {% for flat in flatsT5 %}
                                    <div class="row">
                                        {% if flat.statut %}
                                            <a href="{{ path('appartement', { 'id': flat.id }) }}">
                                                <div class="col s2 l3">{{ flat.typeLogement.nom }}</div>
                                                <div class="col s4 l3">{{ flat.surface }} m<sup>2</sup></div>
                                                <div class="col s4 l3">{{ flat.prix|number_format(0, '.', ' ') }}€
                                                </div>
                                                <div class="col s2 l3">
                                                    <div class="btn white black-text">Voir</div>
                                                </div>
                                            </a>
                                        {% else %}

                                            <div class="col s2 l3"><i>{{ flat.typeLogement.nom }}</i></div>
                                            <div class="col s4 l3"><i>{{ flat.surface }} m<sup>2</sup></i></div>
                                            <div class="col s4 l3"><i>{{ flat.prix|number_format(0, '.', ' ') }} €</i>
                                            </div>
                                            <div class="col s2 l3"><i>Vendu</i>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col offset-s1 retourSearch2">
            <a class="waves-effect waves-light btn"
               href="{{ path("nosresidences") }}">
                <i class="fa fa-caret-left white-text"></i> RETOUR AUX RÉSIDENCES</a>
        </div>
    </div>

    <!-- Suggestion residence -->
    <h1>La sélection My Orléans</h1>

    <div class="row">
        <div class="col offset-l1 s12 l10">
            <div class="row">
                {% for residence in residencesSuggerees %}
                    <div class="col s3">
                        <div class="card">
                            <div class="card-image">
                                <a href="{{ path('residences', { 'slug': residence.slug }) }}">
                                    {% if residence.medias is not empty %}
                                        {% for media in residence.medias if media.typeMedia.nom == 'image-cover' %}
                                            <img src="{{ asset('uploads/'~media.mediaName) | imagine_filter('thumb_residence') }}"
                                                 alt="residence">
                                        {% endfor %}
                                    {% endif %}
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

{% endblock content %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        jQuery(document).ready(function ($) {
            $(window).scroll(function () {

                var scrollTop = $(window).scrollTop(),

                    scroll = document.getElementById("residence").offsetHeight,

                    nav = document.getElementById("nav").offsetHeight,

                    menu = $(document.getElementById("menuResidence"));

                if (scrollTop >= scroll) {
                    menu.css({
                        position: 'fixed',
                        top: nav
                    });
                }
                if (scrollTop <= scroll) {
                    menu.removeAttr('style');
                }
            })
        });
    </script>
    <script type="text/javascript">
        jQuery(document).ready(function ($) {
            $(window).scroll(function () {

                var scrollTop = $(window).scrollTop(),
                    nav = document.getElementById("nav").offsetHeight;

                if (scrollTop >= document.getElementById("anchor-residence").offsetTop - nav) {
                    $(document.getElementById("residenceNav")).addClass('active');
                    $(document.getElementById("offre")).addClass('zoomOffre');
                }

                if (scrollTop < document.getElementById("anchor-residence").offsetTop - nav) {
                    $(document.getElementById("residenceNav")).removeClass('active');
                }

                if (scrollTop >= document.getElementById("anchor-localisation").offsetTop - nav) {
                    $(document.getElementById("localisationNav")).addClass('active');
                    $(document.getElementById("residenceNav")).removeClass('active');
                }

                if (scrollTop < document.getElementById("anchor-localisation").offsetTop - nav) {
                    $(document.getElementById("localisationNav")).removeClass('active');
                }

                if (scrollTop >= document.getElementById("anchor-bien").offsetTop - nav) {
                    $(document.getElementById("bienNav")).addClass('active');
                    $(document.getElementById("localisationNav")).removeClass('active');
                }

                if (scrollTop < document.getElementById("anchor-bien").offsetTop - nav) {
                    $(document.getElementById("bienNav")).removeClass('active');
                }
            })
        });
    </script>
    <script src="{{ asset('js/testcompteur.js') }}"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            // Slider residence
            $('.slider').slider({
                indicators: false,
                interval: 12000,
                height: null
            }, 'pause');

            $('.slider').slider('pause');

            $('.next').click(function () {
                $('.slider').slider('next');
            });
            $('.prev').click(function () {
                $('.slider').slider('prev');
            });

            $('select').material_select();

            $('.parallax').parallax();

            $('.carousel').carousel({
                indicators: true,
                dist: 0,
                shift: 20,
                duration: 100
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            $('a[href*="anchor-"]').click(function () { // Au clic sur un élément
                var page = $(this).attr('href'); // Page cible
                var speed = 750; // Durée de l'animation (en ms)
                $('html, body').animate({scrollTop: $(page).offset().top - 10}, speed); // Go
                return false;
            });
        });
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            // the "href" attribute of the modal trigger must specify the modal ID that wants to be triggered
            $('#modalYtp').modal(
                {
                    dismissible: true,
                    complete: function () {
                        $("#modalYtp iframe").attr("src", $("#modalYtp iframe").attr("src"))
                    }

                });
        });
    </script>

    <script>
        $(document).ready(function () {

            var commerce = ['boulangerie', 'epicerie', 'supermarche'];
            var service = ['banque', 'school', 'parc', 'pharmacie'];
            var transport = ['train_station', 'arret de tram', 'station de velos'];
            var htmlCommerce = '';
            var htmlService = '';
            var htmlTransport = '';

            $.each(commerce, function (index, value) {
                var name = value.replace(/_/g, " ");
                htmlCommerce += '<span class="col s4"><input onclick="renderMap()" type="radio" class="type" id="' + value + '" value="' + value + '" name="filtre"/><label for="' + value + '"><img class="filtreMap" src="/img/googleMap/' + value + '.png"/></label></span>';
            });

            $.each(service, function (index, value) {
                var name = value.replace(/_/g, " ");
                htmlService += '<span class="col s3"><input onclick="renderMap()" type="radio" class="type" id="' + value + '" value="' + value + '" name="filtre"/><label for="' + value + '"><img class="filtreMap" src="/img/googleMap/' + value + '.png"/></label></span>';
            });

            $.each(transport, function (index, value) {
                var name = value.replace(/_/g, " ");
                htmlTransport += '<span class="col s4"><input onclick="renderMap()" type="radio" class="type" id="' + value + '" value="' + value + '" name="filtre"/><label for="' + value + '"><img class="filtreMap" src="/img/googleMap/' + value + '.png"/></label></span>';
            });

            $('#commerce').html(htmlCommerce);

            $('#service').html(htmlService);

            $('#transport').html(htmlTransport);
        });

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        var map;
        var infowindow;
        var selectedTypes = [];

        function initialize() {

            var residence = {lat: {{ residence.latitude }} , lng: {{ residence.longitude }} };

            map = new google.maps.Map(document.getElementById('map'), {
                center: residence,
                zoom: 15

            });

            var marker = new google.maps.Marker({
                position: residence,
                icon: '../img/marker.png'
            });

            // To add the marker to the map, call setMap();
            marker.setMap(map);
        }

        function renderMap() {
            // Get the user defined values
            var residence = {lat: {{ residence.latitude }} , lng: {{ residence.longitude }} };
            var radius = 3000;

            // get the selected type
            selectedTypes = [];
            $('.type').each(function () {
                if ($(this).is(':checked')) {
                    selectedTypes.push($(this).val());
                }
            });

            console.log(selectedTypes);

            var geocoder = new google.maps.Geocoder();
            var selLocLat = 0;
            var selLocLng = 0;

            geocoder.geocode({'location': residence}, function (results, status) {
                if (status === 'OK') {
                    //console.log(results[0].geometry.location.lat() + ' - ' + results[0].geometry.location.lng());

                    selLocLat = results[0].geometry.location.lat();
                    selLocLng = results[0].geometry.location.lng();

                    var residence = new google.maps.LatLng(selLocLat, selLocLng);

                    map = new google.maps.Map(document.getElementById('map'), {
                        center: residence,
                        zoom: 15
                    });


                    var marker = new google.maps.Marker({
                        position: residence,
                        map: map,
                        icon: '../img/marker.png'
                    });

                    //console.log(selectedTypes);

                    var request = {
                        location: residence,
                        radius: radius,
                        keyword: selectedTypes


                    };

                    infowindow = new google.maps.InfoWindow();

                    var service = new google.maps.places.PlacesService(map);
                    service.nearbySearch(request, callback);
                }
                else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        function callback(results, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                for (var i = 0; i < results.length; i++) {
                    createMarker(results[i], results[i].icon);
                }
            }
        }

        function createMarker(place, icon) {
            var placeLoc = place.geometry.location;

//            var icons = {
//                school: {
//                    icon: '../img/googleMap/school.png'
//                },
//                boulangerie: {
//                    icon: '../img/googleMap/boulangerie.png'
//                }
//            };
//
//            var features = [
//                {
//                    position: place.geometry.location,
//                    keyword: 'school'
//                }, {
//                    position: place.geometry.location,
//                    keyword: 'boulangerie'
//                }
//            ];
//
//            features.forEach(function(feature) {
//                var marker = new google.maps.Marker({
//                    position: feature.position,
//                    icon: {
//                        url: icons[feature.keyword].icon,
//                        scaledSize: new google.maps.Size(36, 36) // pixels
//                    },
//                    map: map
//                });
//            });

            var marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                icon: {
                    url: '../img/marker.png',
                    scaledSize: new google.maps.Size(30, 36) // pixels
//                animation: google.maps.Animation.DROP
                }
            });

            google.maps.event.addListener(marker, 'click', function () {
                infowindow.setContent(place.name + '<br>' + place.vicinity);
                infowindow.open(map, this);
            });
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChaGGAaNFdi508AC8JBUs9rhjAOPNnyBU&libraries=places&callback=initialize"
            async defer></script>

{% endblock %}